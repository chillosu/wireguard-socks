version: '3.8'

services:
  wg-server:
    image: linuxserver/wireguard
    container_name: wg-server
    cap_add:
      - NET_ADMIN
    privileged: true
    volumes:
      - /tmp/wg-server.conf:/etc/wireguard/wg0.conf
    networks:
      - wg-test-net
    healthcheck:
      test: ["CMD", "ip", "link", "show", "wg0"]
      interval: 1s
      timeout: 5s
      retries: 3
      start_period: 10s

  wg-client-socks-server:
    image: wireguard-socks:local
    container_name: wg-client-socks-server
    cap_add:
      - NET_ADMIN
    privileged: true
    sysctls:
      net.ipv4.conf.all.src_valid_mark: 1
    environment:
      - LOG_CONFS=false
      - TZ=UTC
    volumes:
      - /tmp/wg_client_config/wg_confs:/config/wg_confs
    networks:
      - wg-test-net
    depends_on:
      wg-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/healthcheck.sh"]
      interval: 1s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  wg-test-net:
    name: wg-test-net 